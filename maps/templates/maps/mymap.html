{% extends 'mysite/base.html' %}

{% block css_in_head_section %}
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.0/mapbox-gl.css' rel='stylesheet' />

{% endblock %}

{% block js_in_head_section %}
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.0/mapbox-gl.js'></script>
{% endblock %}

{% block content %}
    <div class="row pt-4">
        <div class="col-lg-8">
  
            Welcome to the Maps Page!!
            Hi {{my_test_var}}
            
            <p>
            
            <div id='map' style='width: 400px; height: 300px;'></div>
            <p>
            <button id="start_tracking_button" class="btn btn-lg btn-primary" type="button" style="visibility: hidden" onclick="start_tracking()">
                Start Tracking
            </button>
            <button id="stop_tracking_button" class="btn btn-lg btn-primary" type="button" style="visibility: hidden" onclick="stop_tracking()">
                Stop Tracking
            </button>
            <textarea id="coordinates_thru_websockets" cols="100" rows="10"></textarea><br/>
            
            <div id="start_stop_time">
                Start Stop Time here
            </div>

            COORDINATES:
            <div id="coordinate_list">
                You are nowhere!
            </div>
            
        </div>
    </div>

{% endblock %}    

{% block javascript_after_body_section %}
    <script>
        var start_stop_times=[];
        var coordinates = [];
        var watch_position_id;
        var roomName = {{ room_name_json }};
        var mapsSocket = new WebSocket(
            'ws://' + window.location.host +
            '/ws/maps/' + roomName + '/');

        // MapBox stuff
        window.lat = 41.891833;
        window.lng = -87.628228;
        var map;
        var mark;
        var geojson_line_id = "route";

        function my_initialize(){
            mapsSocket.onmessage = function(e) {
            var data = JSON.parse(e.data);
            var username = data['username'];
            var coordinates = data['coordinates'];
            //document.querySelector('#coordinates_thru_websockets').value += (message + '\n');
            document.querySelector('#coordinates_thru_websockets').value += (username + '\n');
            document.querySelector('#coordinates_thru_websockets').value += (JSON.stringify(coordinates) + '\n');
            };

            mapsSocket.onclose = function(e) {
            console.error('Maps socket closed unexpectedly');
            };
            
            get_location();

            initialize_mapbox();
        }

        function initialize_mapbox() {
            mapboxgl.accessToken = '{{mapbox_access_token}}';  
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v9',
                center: [lng, lat], // starting position as [lng, lat]
                zoom: 15
            });

            mark = new mapboxgl.Marker()
                .setLngLat([lng, lat]) // [lng, lat] coordinates to place the marker at
                .addTo(map); // add the marker to the map
      
            alert('We have been initialized');
        }
        function get_location() {
            if ("geolocation" in navigator) {
                alert("You got geolocation working on your browser!");
                document.getElementById('start_tracking_button').style.visibility="visible";
                document.getElementById('stop_tracking_button').setAttribute("disabled", "disabled");
                document.getElementById('stop_tracking_button').style.visibility="visible";
            } else {
              // no native support; maybe try a fallback?
              alert("Oh no. You don't have geolocation in your browser!");
            }
          }
        
        function show_map(position) {
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;

            
            // adds new longitude and latitude to array on the client's browser
            coordinates.push([longitude, latitude]);

     
            // send new longitude and latitude to server via websockets
            var coord = [longitude,latitude]
        
            var time_stamp = new Date().getTime()/1000;
            

            mapsSocket.send(JSON.stringify({
                'message_type': "coordinate",
                'username': "{{user.username}}",
                'coord': coord,
                'search_party_instance_id': "{{room_name}}",
                'time_stamp' : time_stamp
            }));

            var element = document.getElementById("coordinate_list");
            element.innerHTML = "Your coordinates are:(longitude, latitude) " + JSON.stringify(coordinates);
            
            //alert("Found you at longitude " + longitude + ", latitude " + latitude);
            
            // let's show a map or do something interesting!

            window.lat = latitude;
            window.lng = longitude;

            map.flyTo({center:[lng,lat]});
            mark.setLngLat([lng,lat]);

            if (map.getSource(geojson_line_id)) {
            map.removeLayer(geojson_line_id);
            map.removeSource(geojson_line_id);
            }
            map.addLayer({
                "id": geojson_line_id,
                "type": "line",
                "source": {
                    "type": "geojson",
                    "data": {
                    "type": "Feature",
                    "properties": {},
                    "geometry": {
                    "type": "LineString",
                    "coordinates": coordinates
                }
            }
        },
                "layout": {
                "line-join": "round",
                "line-cap": "round"
                },
                "paint": {
                "line-color": "#888",
                "line-width": 8
                }
            });

        }

        function error(err) {
            alert('ERROR(' + err.code + '): ' + err.message);
        }
    
        function start_tracking() {
            watch_position_id = navigator.geolocation.watchPosition(show_map, error);
            document.getElementById('stop_tracking_button').removeAttribute("disabled");
            document.getElementById('start_tracking_button').setAttribute("disabled", "disabled");
            
            var date = new Date();
            var time_stamp = date.getTime()/1000;
            var human_date_time = convert_date_to_human_date_time(date);

            start_stop_times.push([1, time_stamp, human_date_time]);
            var element = document.getElementById("start_stop_time");
            element.innerHTML = "Start" + JSON.stringify(start_stop_times);

            mapsSocket.send(JSON.stringify({
                'message_type': "start_tracking",
                'username': "{{user.username}}",
                'search_party_instance_id': "{{room_name}}",
                'time_stamp' : time_stamp
            }));
        }

        function stop_tracking() {
            navigator.geolocation.clearWatch(watch_position_id);
            document.getElementById('stop_tracking_button').setAttribute("disabled", "disabled");
            document.getElementById('start_tracking_button').removeAttribute("disabled");
            
            var date = new Date();
            var time_stamp = date.getTime()/1000;
            
           
            var human_date_time = convert_date_to_human_date_time(date); 
            start_stop_times.push([2, time_stamp, human_date_time]);
            var element = document.getElementById("start_stop_time");
            element.innerHTML = "Stop" + JSON.stringify(start_stop_times);

            mapsSocket.send(JSON.stringify({
                'message_type': "stop_tracking",
                'username': "{{user.username}}",
                'search_party_instance_id': "{{room_name}}",
                'time_stamp' : time_stamp
            }));

            alert("You have stopped tracking!");

        }

        function convert_date_to_human_date_time(date) {
            var human_date_time = (date.getMonth()+1).toString() + '-' + date.getDate().toString() + '-' + date.getFullYear().toString() 
                  + ' -- ' + date.getHours().toString() + ':' + date.getMinutes().toString() + ': ' + date.getSeconds().toString(); 
            return human_date_time;
        }

    window.onload = my_initialize;  
    
    </script>
    
{% endblock %}